<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor IFC Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
        }
        
        #viewer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #toolbar { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 280px;
        }
        
        #toolbar h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        #ifcInput {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #ifcInput:hover {
            border-color: #4CAF50;
        }
        
        #status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
            font-weight: 500;
        }
        
        .loading { 
            background: #fff3cd; 
            color: #856404;
            display: block !important;
        }
        
        .success { 
            background: #d4edda; 
            color: #155724;
            display: block !important;
        }
        
        .error { 
            background: #f8d7da; 
            color: #721c24;
            display: block !important;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="viewer-container">
        <div id="toolbar">
            <h3>üèóÔ∏è Visor IFC</h3>
            <input type="file" id="ifcInput" accept=".ifc">
            <div id="status"></div>
        </div>
        <div id="canvas-container"></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "web-ifc": "https://cdn.jsdelivr.net/npm/web-ifc@0.0.53/web-ifc-api.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { IFCLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/IFCLoader.js';

        const container = document.getElementById('canvas-container');
        const statusEl = document.getElementById('status');
        const fileInput = document.getElementById('ifcInput');
        
        function showStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = type;
            statusEl.style.display = 'block';
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        showStatus('Inicializando visor 3D...', 'loading');

        // Escena
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2c3e50);

        // C√°mara
        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            2000
        );
        camera.position.set(15, 15, 15);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            alpha: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Controles
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2;
        controls.minDistance = 5;
        controls.maxDistance = 500;

        // Luces
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1);
        sunLight.position.set(50, 50, 50);
        sunLight.castShadow = true;
        sunLight.shadow.camera.far = 200;
        sunLight.shadow.camera.left = -50;
        sunLight.shadow.camera.right = 50;
        sunLight.shadow.camera.top = 50;
        sunLight.shadow.camera.bottom = -50;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        scene.add(sunLight);

        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-30, 30, -30);
        scene.add(fillLight);

        // Grid
        const gridHelper = new THREE.GridHelper(200, 50, 0x555555, 0x333333);
        scene.add(gridHelper);

        // Axes helper
        const axesHelper = new THREE.AxesHelper(10);
        scene.add(axesHelper);

        // IFC Loader
        const ifcLoader = new IFCLoader();
        ifcLoader.ifcManager.setWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.53/');

        let currentModel = null;

        // Manejador de carga de archivos
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showStatus(`Preparando ${file.name}...`, 'loading');

            // Limpiar modelo anterior
            if (currentModel) {
                scene.remove(currentModel);
                ifcLoader.ifcManager.dispose();
                currentModel = null;
            }

            const url = URL.createObjectURL(file);

            try {
                showStatus('Cargando archivo IFC...', 'loading');

                ifcLoader.load(
                    url,
                    (ifcModel) => {
                        currentModel = ifcModel;
                        scene.add(ifcModel);

                        // Calcular dimensiones
                        const box = new THREE.Box3().setFromObject(ifcModel);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());

                        // Ajustar grid
                        gridHelper.position.y = box.min.y - 0.1;

                        // Centrar controles
                        controls.target.copy(center);

                        // Posicionar c√°mara
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const fov = camera.fov * (Math.PI / 180);
                        let distance = Math.abs(maxDim / Math.tan(fov / 2));
                        distance *= 1.8;

                        const direction = new THREE.Vector3(1, 0.8, 1).normalize();
                        camera.position.copy(center).add(direction.multiplyScalar(distance));
                        camera.lookAt(center);
                        controls.update();

                        URL.revokeObjectURL(url);
                        
                        showStatus(`‚úì ${file.name} cargado exitosamente`, 'success');
                        
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 4000);
                    },
                    (progressEvent) => {
                        if (progressEvent.lengthComputable) {
                            const percent = ((progressEvent.loaded / progressEvent.total) * 100).toFixed(1);
                            showStatus(`Cargando: ${percent}%`, 'loading');
                        }
                    },
                    (error) => {
                        console.error('Error al cargar IFC:', error);
                        showStatus(`‚úó Error: ${error.message || 'No se pudo cargar el archivo'}`, 'error');
                        URL.revokeObjectURL(url);
                    }
                );

            } catch (error) {
                console.error('Error inesperado:', error);
                showStatus(`‚úó Error inesperado: ${error.message}`, 'error');
                URL.revokeObjectURL(url);
            }
        });

        // Responsive
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Loop de animaci√≥n
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        animate();
        
        showStatus('‚úì Visor listo. Selecciona un archivo IFC', 'success');
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    </script>
</body>
</html>
